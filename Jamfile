import feature : feature ;

install stage-test : udp_test : <location>. ;
install stage : utrack : <location>. ;

feature net : system pcap netmap pcap-receive-only : composite propagated link-incompatible ;
feature.compose <net>pcap-receive-only : <define>USE_SYSTEM_SEND_SOCKET ;
feature.compose <net>netmap : <define>USE_NETMAP ;

explicit stage-test ;
explicit stage ;

lib libpcap : : <name>pcap : <search>/opt/local/lib
	: <include>/opt/local/include ;

lib libwpcap : : <name>wpcap : <search>"c:\\Program Files\\wpdpack\\lib"
	:
	<include>"c:\\Program Files\\wpdpack\\include" ;

rule net ( properties * )
{
	local result ;
	if <net>system in $(properties)
	{
		result += <source>socket_system.cpp ;
	}
	else if <net>netmap in $(properties)
	{
		result += <source>socket_netmap.cpp ;

		# temporary, until we have interfaces() not depend on libpcap
		result += <library>libpcap ;
	}
	else
	{
		if <target-os>windows in $(properties)
		{
			result += <library>libwpcap <define>USE_WINPCAP <define>USE_PCAP ;
		}
		else
		{
			result += <library>libpcap <define>USE_PCAP ;
		}

		result += <source>socket_pcap.cpp ;
	}
	return $(result) ;
}

lib ws2 : : <name>ws2_32 ;
lib iphlp : : <name>iphlpapi ;

exe udp_test
	:
	test_announce.cpp
	utils.cpp
	stack.cpp
	:
	<conditional>@net
	<target-os>windows:<library>ws2
	<target-os>windows:<library>iphlp
	<threading>multi
	;

explicit udp_test ;

exe utrack
	:
	main.cpp
	swarm.cpp
	announce_thread.cpp
	siphash24.c
	key_rotate.cpp
	receive_thread.cpp
	utils.cpp
	stack.cpp
	:
	<target-os>windows:<library>ws2
	<target-os>windows:<library>iphlp
	<conditional>@net
	<threading>multi
	;

